<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agent Execution Flow</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 30px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        
        h1 {
            text-align: center;
            color: #2d3748;
            margin-bottom: 10px;
            font-size: 2.2em;
        }
        
        .subtitle {
            text-align: center;
            color: #718096;
            margin-bottom: 40px;
            font-size: 1em;
        }
        
        .flow-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .flow-step {
            display: grid;
            grid-template-columns: 80px 1fr 1fr;
            gap: 20px;
            align-items: start;
            padding: 20px;
            background: #f7fafc;
            border-radius: 12px;
            border-left: 5px solid #667eea;
            transition: all 0.3s ease;
        }
        
        .flow-step:hover {
            transform: translateX(5px);
            box-shadow: 0 8px 16px rgba(0,0,0,0.1);
        }
        
        .step-number {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.5em;
            box-shadow: 0 4px 8px rgba(102, 126, 234, 0.3);
        }
        
        .step-content {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .step-title {
            font-size: 1.3em;
            font-weight: bold;
            color: #2d3748;
        }
        
        .step-desc {
            color: #4a5568;
            line-height: 1.6;
        }
        
        .step-module {
            background: white;
            padding: 12px 16px;
            border-radius: 8px;
            border: 2px solid #e2e8f0;
        }
        
        .module-name {
            font-family: 'Courier New', monospace;
            color: #667eea;
            font-weight: bold;
            font-size: 0.95em;
        }
        
        .module-function {
            color: #718096;
            font-size: 0.85em;
            margin-top: 4px;
        }
        
        .arrow-down {
            text-align: center;
            color: #667eea;
            font-size: 2em;
            margin: -10px 0;
        }
        
        .data-flow {
            background: #edf2f7;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.85em;
            color: #4a5568;
            margin-top: 8px;
            border-left: 3px solid #48bb78;
        }
        
        .highlight {
            background: #fef5e7;
            border-left-color: #f6ad55;
        }
        
        .success {
            background: #f0fff4;
            border-left-color: #48bb78;
        }
        
        @media print {
            body {
                background: white;
                padding: 10px;
            }
            .container {
                box-shadow: none;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîÑ Flujo de Ejecuci√≥n del Agente</h1>
        <p class="subtitle">Desde el input del usuario hasta la reserva confirmada</p>
        
        <div class="flow-container">
            
            <!-- STEP 1 -->
            <div class="flow-step">
                <div class="step-number">1</div>
                <div class="step-content">
                    <div class="step-title">Input del Usuario</div>
                    <div class="step-desc">
                        El usuario ejecuta el comando y escribe su petici√≥n en lenguaje natural
                    </div>
                    <div class="data-flow">
                        üí¨ "B√∫scame una pizzer√≠a en Navalcarnero para 3 personas a las 21h"
                    </div>
                </div>
                <div class="step-module">
                    <div class="module-name">run.py</div>
                    <div class="module-function">‚Üí main() ‚Üí modo interactive</div>
                </div>
            </div>
            
            <div class="arrow-down">‚Üì</div>
            
            <!-- STEP 2 -->
            <div class="flow-step">
                <div class="step-number">2</div>
                <div class="step-content">
                    <div class="step-title">Inicializaci√≥n del Agente</div>
                    <div class="step-desc">
                        Se crea el estado inicial y se compila el grafo de LangGraph con todos los nodos conectados
                    </div>
                    <div class="data-flow">
                        üì¶ Estado inicial: {messages: [...], current_step: "classify_intent"}
                    </div>
                </div>
                <div class="step-module">
                    <div class="module-name">agent/main.py</div>
                    <div class="module-function">‚Üí RestaurantBookingAgent()<br>‚Üí create_agent_graph()</div>
                    <div class="module-name" style="margin-top: 8px;">agent/agent_state.py</div>
                    <div class="module-function">‚Üí create_initial_state()</div>
                </div>
            </div>
            
            <div class="arrow-down">‚Üì</div>
            
            <!-- STEP 3 -->
            <div class="flow-step highlight">
                <div class="step-number">3</div>
                <div class="step-content">
                    <div class="step-title">Clasificaci√≥n de Intenci√≥n</div>
                    <div class="step-desc">
                        El LLM analiza el mensaje y determina qu√© quiere hacer el usuario (buscar, reservar, cancelar...)
                    </div>
                    <div class="data-flow">
                        üß† LLM + CLASSIFY_INTENT_PROMPT ‚Üí UserIntent: "search_and_book" (0.90 confidence)
                    </div>
                </div>
                <div class="step-module">
                    <div class="module-name">agent/agent_nodes.py</div>
                    <div class="module-function">‚Üí classify_intent_node()<br>‚Üí call_llm()</div>
                    <div class="module-name" style="margin-top: 8px;">agent/prompts.py</div>
                    <div class="module-function">‚Üí CLASSIFY_INTENT_PROMPT</div>
                </div>
            </div>
            
            <div class="arrow-down">‚Üì</div>
            
            <!-- STEP 4 -->
            <div class="flow-step highlight">
                <div class="step-number">4</div>
                <div class="step-content">
                    <div class="step-title">Extracci√≥n de Par√°metros</div>
                    <div class="step-desc">
                        El LLM extrae los par√°metros del lenguaje natural: ubicaci√≥n, fecha, hora, n√∫mero de personas, tipo de comida
                    </div>
                    <div class="data-flow">
                        üß† LLM + EXTRACT_PARAMETERS_PROMPT ‚Üí ReservationParams: {query: "pizzer√≠a", location: "Navalcarnero", date: "2025-12-21", time: "21:00", num_people: 3}
                    </div>
                </div>
                <div class="step-module">
                    <div class="module-name">agent/agent_nodes.py</div>
                    <div class="module-function">‚Üí extract_parameters_node()<br>‚Üí call_llm()</div>
                    <div class="module-name" style="margin-top: 8px;">agent/prompts.py</div>
                    <div class="module-function">‚Üí EXTRACT_PARAMETERS_PROMPT</div>
                </div>
            </div>
            
            <div class="arrow-down">‚Üì</div>
            
            <!-- STEP 5 -->
            <div class="flow-step">
                <div class="step-number">5</div>
                <div class="step-content">
                    <div class="step-title">Verificaci√≥n de Completitud</div>
                    <div class="step-desc">
                        Se verifica si hay suficiente informaci√≥n. Si falta algo cr√≠tico, el agente pregunta al usuario (HITL)
                    </div>
                    <div class="data-flow">
                        ‚úÖ Informaci√≥n completa ‚Üí Contin√∫a a b√∫squeda<br>
                        ‚ùå Falta info ‚Üí ask_user_node() ‚Üí Pausa (HITL)
                    </div>
                </div>
                <div class="step-module">
                    <div class="module-name">agent/agent_nodes.py</div>
                    <div class="module-function">‚Üí check_completeness_node()<br>‚Üí is_state_complete_for_search()</div>
                    <div class="module-name" style="margin-top: 8px;">agent/agent_graph.py</div>
                    <div class="module-function">‚Üí route_after_completeness_check()</div>
                </div>
            </div>
            
            <div class="arrow-down">‚Üì</div>
            
            <!-- STEP 6 -->
            <div class="flow-step">
                <div class="step-number">6</div>
                <div class="step-content">
                    <div class="step-title">B√∫squeda de Restaurantes</div>
                    <div class="step-desc">
                        Se buscan restaurantes usando Google Places API. La ubicaci√≥n se geocodifica y se obtienen detalles completos de cada restaurante
                    </div>
                    <div class="data-flow">
                        üîç GooglePlacesTool ‚Üí backend_google_places.py ‚Üí Google Places API<br>
                        üìä Resultado: 20 restaurantes con detalles completos
                    </div>
                </div>
                <div class="step-module">
                    <div class="module-name">agent/agent_nodes.py</div>
                    <div class="module-function">‚Üí search_restaurants_node()</div>
                    <div class="module-name" style="margin-top: 8px;">agent/tools.py</div>
                    <div class="module-function">‚Üí GooglePlacesTool.run()</div>
                    <div class="module-name" style="margin-top: 8px;">backend_google_places.py</div>
                    <div class="module-function">‚Üí places_text_search()</div>
                </div>
            </div>
            
            <div class="arrow-down">‚Üì</div>
            
            <!-- STEP 7 -->
            <div class="flow-step">
                <div class="step-number">7</div>
                <div class="step-content">
                    <div class="step-title">Verificaci√≥n de Disponibilidad</div>
                    <div class="step-desc">
                        Para cada restaurante se verifica: ¬øTiene sistema de reservas online? ¬øEst√° disponible a esa hora?
                    </div>
                    <div class="data-flow">
                        üè™ CoverManagerTool (Mock inteligente):<br>
                        ‚Ä¢ Detecta cadenas conocidas ‚Üí API<br>
                        ‚Ä¢ Simula disponibilidad seg√∫n hora pico<br>
                        ‚Ä¢ Genera horarios alternativos si no hay mesa
                    </div>
                </div>
                <div class="step-module">
                    <div class="module-name">agent/agent_nodes.py</div>
                    <div class="module-function">‚Üí check_availability_node()</div>
                    <div class="module-name" style="margin-top: 8px;">agent/tools.py</div>
                    <div class="module-function">‚Üí CoverManagerTool.check_availability()<br>‚Üí _has_online_booking()<br>‚Üí _is_peak_hour()</div>
                </div>
            </div>
            
            <div class="arrow-down">‚Üì</div>
            
            <!-- STEP 8 -->
            <div class="flow-step highlight">
                <div class="step-number">8</div>
                <div class="step-content">
                    <div class="step-title">Ranking Inteligente (TOP 3)</div>
                    <div class="step-desc">
                        El LLM analiza todos los restaurantes y genera un TOP 3 bas√°ndose en: rating, disponibilidad, reviews, precio, ubicaci√≥n
                    </div>
                    <div class="data-flow">
                        üß† LLM + RANK_RESTAURANTS_PROMPT ‚Üí TOP 3 con scores y razonamientos<br>
                        ü•á Pizzer√≠a T√≠o Miguel (8.5) - "Excelente rating y disponible"
                    </div>
                </div>
                <div class="step-module">
                    <div class="module-name">agent/agent_nodes.py</div>
                    <div class="module-function">‚Üí rank_restaurants_node()<br>‚Üí call_llm()</div>
                    <div class="module-name" style="margin-top: 8px;">agent/prompts.py</div>
                    <div class="module-function">‚Üí RANK_RESTAURANTS_PROMPT</div>
                </div>
            </div>
            
            <div class="arrow-down">‚Üì</div>
            
            <!-- STEP 9 -->
            <div class="flow-step">
                <div class="step-number">9</div>
                <div class="step-content">
                    <div class="step-title">Presentaci√≥n al Usuario (HITL)</div>
                    <div class="step-desc">
                        Se muestra el TOP 3 al usuario y el agente espera su selecci√≥n. Punto de pausa para decisi√≥n humana
                    </div>
                    <div class="data-flow">
                        üí¨ Agente: "¬øCu√°l prefieres? (1, 2 o 3)"<br>
                        ‚è∏Ô∏è PAUSA - Esperando input del usuario
                    </div>
                </div>
                <div class="step-module">
                    <div class="module-name">agent/agent_nodes.py</div>
                    <div class="module-function">‚Üí present_options_node()</div>
                    <div class="module-name" style="margin-top: 8px;">agent/prompts.py</div>
                    <div class="module-function">‚Üí format_top_3_for_user()</div>
                    <div class="module-name" style="margin-top: 8px;">agent/agent_graph.py</div>
                    <div class="module-function">‚Üí END (HITL pause)</div>
                </div>
            </div>
            
            <div class="arrow-down">‚Üì</div>
            
            <!-- STEP 10 -->
            <div class="flow-step">
                <div class="step-number">10</div>
                <div class="step-content">
                    <div class="step-title">Selecci√≥n del Usuario</div>
                    <div class="step-desc">
                        El usuario responde con su elecci√≥n. El agente resume la conversaci√≥n con el nuevo input
                    </div>
                    <div class="data-flow">
                        üí¨ Usuario: "El primero"<br>
                        üîÑ resume_agent_after_user_input() ‚Üí Parsea selecci√≥n
                    </div>
                </div>
                <div class="step-module">
                    <div class="module-name">agent/agent_graph.py</div>
                    <div class="module-function">‚Üí resume_agent_after_user_input()<br>‚Üí parse_restaurant_selection()</div>
                </div>
            </div>
            
            <div class="arrow-down">‚Üì</div>
            
            <!-- STEP 11 -->
            <div class="flow-step">
                <div class="step-number">11</div>
                <div class="step-content">
                    <div class="step-title">Intento de Reserva por API</div>
                    <div class="step-desc">
                        Si el restaurante tiene sistema de reservas online, se intenta hacer la reserva por API
                    </div>
                    <div class="data-flow">
                        ‚úÖ has_api_booking = True ‚Üí Intenta reserva<br>
                        ‚ùå has_api_booking = False ‚Üí Salta a fallback_voice<br>
                        ‚ùå API falla ‚Üí Salta a fallback_voice
                    </div>
                </div>
                <div class="step-module">
                    <div class="module-name">agent/agent_nodes.py</div>
                    <div class="module-function">‚Üí book_restaurant_node()</div>
                    <div class="module-name" style="margin-top: 8px;">agent/tools.py</div>
                    <div class="module-function">‚Üí CoverManagerTool.make_reservation()</div>
                    <div class="module-name" style="margin-top: 8px;">agent/agent_graph.py</div>
                    <div class="module-function">‚Üí route_after_booking()</div>
                </div>
            </div>
            
            <div class="arrow-down">‚Üì</div>
            
            <!-- STEP 12 -->
            <div class="flow-step">
                <div class="step-number">12</div>
                <div class="step-content">
                    <div class="step-title">Fallback a Voz (si necesario)</div>
                    <div class="step-desc">
                        Si la API no est√° disponible o falla, el agente autom√°ticamente intenta hacer la reserva por llamada telef√≥nica
                    </div>
                    <div class="data-flow">
                        üìû TwilioVoiceTool (Mock): Simula llamada + transcripci√≥n<br>
                        üéôÔ∏è Analiza respuesta del restaurante ‚Üí Confirmaci√≥n
                    </div>
                </div>
                <div class="step-module">
                    <div class="module-name">agent/agent_nodes.py</div>
                    <div class="module-function">‚Üí fallback_voice_node()</div>
                    <div class="module-name" style="margin-top: 8px;">agent/tools.py</div>
                    <div class="module-function">‚Üí TwilioVoiceTool.make_voice_reservation()</div>
                </div>
            </div>
            
            <div class="arrow-down">‚Üì</div>
            
            <!-- STEP 13 -->
            <div class="flow-step success">
                <div class="step-number">‚úì</div>
                <div class="step-content">
                    <div class="step-title">Confirmaci√≥n Final</div>
                    <div class="step-desc">
                        Se muestra al usuario la confirmaci√≥n completa con todos los detalles de la reserva
                    </div>
                    <div class="data-flow">
                        ‚úÖ "Reserva confirmada en Pizzer√≠a T√≠o Miguel para 3 personas el 2025-12-21 a las 21:00"<br>
                        üìã Detalles: tel√©fono, direcci√≥n, ID de reserva
                    </div>
                </div>
                <div class="step-module">
                    <div class="module-name">agent/agent_nodes.py</div>
                    <div class="module-function">‚Üí finalize_node()</div>
                    <div class="module-name" style="margin-top: 8px;">agent/prompts.py</div>
                    <div class="module-function">‚Üí SUCCESS_MESSAGE</div>
                </div>
            </div>
            
        </div>
        
        <div style="margin-top: 40px; padding: 25px; background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%); border-radius: 12px; border-left: 5px solid #48bb78;">
            <strong style="font-size: 1.2em; color: #2d3748;">üîë Conceptos Clave:</strong>
            <div style="margin-top: 15px; display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                <div>
                    <strong style="color: #667eea;">HITL (Human-in-the-Loop):</strong><br>
                    <span style="color: #4a5568;">El agente pausa y espera decisi√≥n del usuario en pasos cr√≠ticos</span>
                </div>
                <div>
                    <strong style="color: #667eea;">ReAct (Thought‚ÜíAction‚ÜíObservation):</strong><br>
                    <span style="color: #4a5568;">El agente piensa antes de actuar y aprende de los resultados</span>
                </div>
                <div>
                    <strong style="color: #667eea;">Estado Persistente:</strong><br>
                    <span style="color: #4a5568;">Toda la informaci√≥n fluye por AgentState entre nodos</span>
                </div>
                <div>
                    <strong style="color: #667eea;">Fallback Autom√°tico:</strong><br>
                    <span style="color: #4a5568;">Si API falla ‚Üí Intenta por llamada telef√≥nica sin intervenci√≥n</span>
                </div>
            </div>
        </div>
        
        <!-- LANGGRAPH NODE CONNECTIONS -->
        <div style="margin-top: 40px;">
            <h2 style="color: #2d3748; margin-bottom: 20px; font-size: 1.8em;">üîó Grafo de Nodos de LangGraph</h2>
            <p style="color: #718096; margin-bottom: 25px;">Interconexi√≥n de nodos y decisiones condicionales del agente</p>
            
            <div style="background: #f7fafc; padding: 30px; border-radius: 12px; border: 2px solid #e2e8f0;">
                <svg viewBox="0 0 1000 900" style="width: 100%; height: auto;">
                    <!-- START -->
                    <rect x="420" y="10" width="160" height="50" rx="25" fill="#48bb78" stroke="#2f855a" stroke-width="2"/>
                    <text x="500" y="40" text-anchor="middle" fill="white" font-weight="bold" font-size="16">START</text>
                    
                    <!-- classify_intent -->
                    <rect x="395" y="90" width="210" height="50" rx="10" fill="#667eea" stroke="#5a67d8" stroke-width="2"/>
                    <text x="500" y="120" text-anchor="middle" fill="white" font-weight="bold" font-size="14">classify_intent</text>
                    <line x1="500" y1="60" x2="500" y2="90" stroke="#667eea" stroke-width="2" marker-end="url(#arrowhead)"/>
                    
                    <!-- extract_parameters -->
                    <rect x="375" y="170" width="250" height="50" rx="10" fill="#667eea" stroke="#5a67d8" stroke-width="2"/>
                    <text x="500" y="200" text-anchor="middle" fill="white" font-weight="bold" font-size="14">extract_parameters</text>
                    <line x1="500" y1="140" x2="500" y2="170" stroke="#667eea" stroke-width="2" marker-end="url(#arrowhead)"/>
                    
                    <!-- check_completeness -->
                    <rect x="365" y="250" width="270" height="50" rx="10" fill="#9f7aea" stroke="#805ad5" stroke-width="2"/>
                    <text x="500" y="280" text-anchor="middle" fill="white" font-weight="bold" font-size="14">check_completeness</text>
                    <line x1="500" y1="220" x2="500" y2="250" stroke="#667eea" stroke-width="2" marker-end="url(#arrowhead)"/>
                    
                    <!-- ask_user (left branch) -->
                    <rect x="50" y="340" width="180" height="50" rx="10" fill="#f6ad55" stroke="#dd6b20" stroke-width="2"/>
                    <text x="140" y="370" text-anchor="middle" fill="white" font-weight="bold" font-size="14">ask_user (HITL)</text>
                    <line x1="450" y1="300" x2="140" y2="340" stroke="#f6ad55" stroke-width="2" stroke-dasharray="5,5" marker-end="url(#arrowhead)"/>
                    <text x="280" y="315" fill="#f6ad55" font-size="12" font-weight="bold">‚ùå Falta info</text>
                    
                    <!-- END (from ask_user) -->
                    <rect x="80" y="420" width="120" height="50" rx="25" fill="#fc8181" stroke="#e53e3e" stroke-width="2"/>
                    <text x="140" y="450" text-anchor="middle" fill="white" font-weight="bold" font-size="14">END (HITL)</text>
                    <line x1="140" y1="390" x2="140" y2="420" stroke="#f6ad55" stroke-width="2" marker-end="url(#arrowhead)"/>
                    
                    <!-- search (right branch) -->
                    <rect x="680" y="340" width="230" height="50" rx="10" fill="#4299e1" stroke="#3182ce" stroke-width="2"/>
                    <text x="795" y="370" text-anchor="middle" fill="white" font-weight="bold" font-size="14">search_restaurants</text>
                    <line x1="550" y1="300" x2="795" y2="340" stroke="#4299e1" stroke-width="2" marker-end="url(#arrowhead)"/>
                    <text x="650" y="315" fill="#4299e1" font-size="12" font-weight="bold">‚úÖ Completo</text>
                    
                    <!-- check_availability -->
                    <rect x="660" y="420" width="270" height="50" rx="10" fill="#4299e1" stroke="#3182ce" stroke-width="2"/>
                    <text x="795" y="450" text-anchor="middle" fill="white" font-weight="bold" font-size="14">check_availability</text>
                    <line x1="795" y1="390" x2="795" y2="420" stroke="#4299e1" stroke-width="2" marker-end="url(#arrowhead)"/>
                    
                    <!-- rank -->
                    <rect x="715" y="500" width="160" height="50" rx="10" fill="#9f7aea" stroke="#805ad5" stroke-width="2"/>
                    <text x="795" y="530" text-anchor="middle" fill="white" font-weight="bold" font-size="14">rank</text>
                    <line x1="795" y1="470" x2="795" y2="500" stroke="#4299e1" stroke-width="2" marker-end="url(#arrowhead)"/>
                    
                    <!-- present_options -->
                    <rect x="685" y="580" width="220" height="50" rx="10" fill="#f6ad55" stroke="#dd6b20" stroke-width="2"/>
                    <text x="795" y="610" text-anchor="middle" fill="white" font-weight="bold" font-size="14">present_options (HITL)</text>
                    <line x1="795" y1="550" x2="795" y2="580" stroke="#9f7aea" stroke-width="2" marker-end="url(#arrowhead)"/>
                    
                    <!-- END (from present_options) -->
                    <rect x="735" y="660" width="120" height="50" rx="25" fill="#fc8181" stroke="#e53e3e" stroke-width="2"/>
                    <text x="795" y="690" text-anchor="middle" fill="white" font-weight="bold" font-size="14">END (HITL)</text>
                    <line x1="795" y1="630" x2="795" y2="660" stroke="#f6ad55" stroke-width="2" marker-end="url(#arrowhead)"/>
                    
                    <!-- book (after user selection) -->
                    <rect x="420" y="580" width="160" height="50" rx="10" fill="#48bb78" stroke="#2f855a" stroke-width="2"/>
                    <text x="500" y="610" text-anchor="middle" fill="white" font-weight="bold" font-size="14">book</text>
                    <text x="620" y="605" fill="#718096" font-size="11" font-style="italic">Usuario selecciona</text>
                    
                    <!-- fallback_voice -->
                    <rect x="240" y="680" width="190" height="50" rx="10" fill="#ed8936" stroke="#c05621" stroke-width="2"/>
                    <text x="335" y="710" text-anchor="middle" fill="white" font-weight="bold" font-size="14">fallback_voice</text>
                    <line x1="460" y1="630" x2="380" y2="680" stroke="#ed8936" stroke-width="2" stroke-dasharray="5,5" marker-end="url(#arrowhead)"/>
                    <text x="400" y="650" fill="#ed8936" font-size="12" font-weight="bold">Sin API</text>
                    
                    <!-- finalize (from book) -->
                    <rect x="430" y="760" width="140" height="50" rx="10" fill="#48bb78" stroke="#2f855a" stroke-width="2"/>
                    <text x="500" y="790" text-anchor="middle" fill="white" font-weight="bold" font-size="14">finalize</text>
                    <line x1="520" y1="630" x2="500" y2="760" stroke="#48bb78" stroke-width="2" marker-end="url(#arrowhead)"/>
                    <text x="510" y="690" fill="#48bb78" font-size="12" font-weight="bold">‚úÖ API OK</text>
                    
                    <!-- finalize (from fallback) -->
                    <line x1="365" y1="730" x2="470" y2="770" stroke="#48bb78" stroke-width="2" marker-end="url(#arrowhead)"/>
                    <text x="400" y="745" fill="#48bb78" font-size="12" font-weight="bold">‚úÖ Voz OK</text>
                    
                    <!-- error (from fallback) -->
                    <rect x="80" y="760" width="120" height="50" rx="10" fill="#fc8181" stroke="#e53e3e" stroke-width="2"/>
                    <text x="140" y="790" text-anchor="middle" fill="white" font-weight="bold" font-size="14">error</text>
                    <line x1="285" y1="730" x2="180" y2="760" stroke="#fc8181" stroke-width="2" stroke-dasharray="5,5" marker-end="url(#arrowhead)"/>
                    <text x="220" y="745" fill="#fc8181" font-size="12" font-weight="bold">‚ùå Fallo</text>
                    
                    <!-- END (final) -->
                    <rect x="440" y="840" width="120" height="50" rx="25" fill="#2d3748" stroke="#1a202c" stroke-width="2"/>
                    <text x="500" y="870" text-anchor="middle" fill="white" font-weight="bold" font-size="16">END</text>
                    <line x1="500" y1="810" x2="500" y2="840" stroke="#48bb78" stroke-width="2" marker-end="url(#arrowhead)"/>
                    <line x1="140" y1="810" x2="480" y2="850" stroke="#fc8181" stroke-width="2" marker-end="url(#arrowhead)"/>
                    
                    <!-- Arrow marker definition -->
                    <defs>
                        <marker id="arrowhead" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
                            <polygon points="0 0, 10 3, 0 6" fill="#2d3748" />
                        </marker>
                    </defs>
                </svg>
                
                <div style="margin-top: 30px; padding: 20px; background: white; border-radius: 8px; border-left: 4px solid #667eea;">
                    <strong style="color: #2d3748; font-size: 1.1em;">üìñ Leyenda del Grafo:</strong>
                    <div style="margin-top: 15px; display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; font-size: 0.9em;">
                        <div><span style="color: #667eea;">‚óè</span> <strong>Azul:</strong> Nodos de razonamiento (LLM)</div>
                        <div><span style="color: #4299e1;">‚óè</span> <strong>Azul claro:</strong> Nodos de b√∫squeda/tools</div>
                        <div><span style="color: #9f7aea;">‚óè</span> <strong>Morado:</strong> Nodos de decisi√≥n</div>
                        <div><span style="color: #f6ad55;">‚óè</span> <strong>Naranja:</strong> HITL (pausas para usuario)</div>
                        <div><span style="color: #48bb78;">‚óè</span> <strong>Verde:</strong> Reserva y √©xito</div>
                        <div><span style="color: #ed8936;">‚óè</span> <strong>Naranja oscuro:</strong> Fallback</div>
                        <div><span style="color: #fc8181;">‚óè</span> <strong>Rojo:</strong> Error o fin de interacci√≥n</div>
                        <div><strong>L√≠nea s√≥lida:</strong> Flujo normal</div>
                        <div><strong>L√≠nea punteada:</strong> Flujo condicional</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- FUNCTION INDEX -->
        <div style="margin-top: 40px; page-break-before: always;">
            <h2 style="color: #2d3748; margin-bottom: 20px; font-size: 1.8em;">üìö √çndice de Funciones por M√≥dulo</h2>
            
            <div style="display: grid; gap: 20px;">
                
                <!-- agent_state.py -->
                <div style="background: #f7fafc; padding: 20px; border-radius: 10px; border-left: 4px solid #48bb78;">
                    <h3 style="color: #2d3748; margin-bottom: 15px;">üì¶ agent/agent_state.py</h3>
                    <div style="font-family: 'Courier New', monospace; font-size: 0.9em; color: #4a5568; line-height: 1.8;">
                        <strong>Clases:</strong><br>
                        ‚Ä¢ UserIntent - Clasificaci√≥n de intenci√≥n del usuario<br>
                        ‚Ä¢ ReservationParams - Par√°metros de reserva<br>
                        ‚Ä¢ RestaurantCandidate - Info de restaurante<br>
                        ‚Ä¢ SearchResults - Resultados de b√∫squeda<br>
                        ‚Ä¢ AgentState - Estado global del agente<br>
                        <br>
                        <strong>Funciones:</strong><br>
                        ‚Ä¢ create_initial_state(user_message) ‚Üí AgentState<br>
                        ‚Ä¢ is_state_complete_for_search(state) ‚Üí bool<br>
                        ‚Ä¢ get_missing_critical_params(state) ‚Üí List[str]
                    </div>
                </div>
                
                <!-- agent_prompts.py -->
                <div style="background: #f7fafc; padding: 20px; border-radius: 10px; border-left: 4px solid #ed8936;">
                    <h3 style="color: #2d3748; margin-bottom: 15px;">üí¨ agent/agent_prompts.py</h3>
                    <div style="font-family: 'Courier New', monospace; font-size: 0.9em; color: #4a5568; line-height: 1.8;">
                        <strong>Prompts:</strong><br>
                        ‚Ä¢ SYSTEM_PROMPT - Identidad y comportamiento ReAct<br>
                        ‚Ä¢ CLASSIFY_INTENT_PROMPT - Clasificar intenci√≥n<br>
                        ‚Ä¢ EXTRACT_PARAMETERS_PROMPT - Extraer par√°metros<br>
                        ‚Ä¢ RANK_RESTAURANTS_PROMPT - Generar TOP 3<br>
                        ‚Ä¢ ASK_USER_PROMPT - Generar preguntas<br>
                        ‚Ä¢ PROPOSE_ALTERNATIVE_PROMPT - Proponer alternativas<br>
                        <br>
                        <strong>Funciones:</strong><br>
                        ‚Ä¢ format_system_prompt() ‚Üí str<br>
                        ‚Ä¢ format_conversation_history(messages) ‚Üí str<br>
                        ‚Ä¢ format_top_3_for_user(top_3) ‚Üí str
                    </div>
                </div>
                
                <!-- agent_tools.py -->
                <div style="background: #f7fafc; padding: 20px; border-radius: 10px; border-left: 4px solid #4299e1;">
                    <h3 style="color: #2d3748; margin-bottom: 15px;">üîß agent/agent_tools.py</h3>
                    <div style="font-family: 'Courier New', monospace; font-size: 0.9em; color: #4a5568; line-height: 1.8;">
                        <strong>Clase GooglePlacesTool:</strong><br>
                        ‚Ä¢ run(query, location, ...) ‚Üí Dict<br>
                        <br>
                        <strong>Clase CoverManagerTool:</strong><br>
                        ‚Ä¢ check_availability(place_id, date, time, ...) ‚Üí Dict<br>
                        ‚Ä¢ make_reservation(place_id, name, date, ...) ‚Üí Dict<br>
                        ‚Ä¢ _has_online_booking(...) ‚Üí bool<br>
                        ‚Ä¢ _is_peak_hour(time) ‚Üí bool<br>
                        ‚Ä¢ _calculate_time_offset(time, minutes) ‚Üí str<br>
                        <br>
                        <strong>Clase TwilioVoiceTool:</strong><br>
                        ‚Ä¢ make_voice_reservation(name, phone, ...) ‚Üí Dict<br>
                        <br>
                        <strong>Clase ToolRegistry:</strong><br>
                        ‚Ä¢ get_tool(name) ‚Üí BaseTool<br>
                        ‚Ä¢ list_tools() ‚Üí List[str]
                    </div>
                </div>
                
                <!-- agent_nodes.py -->
                <div style="background: #f7fafc; padding: 20px; border-radius: 10px; border-left: 4px solid #667eea;">
                    <h3 style="color: #2d3748; margin-bottom: 15px;">üß† agent/agent_nodes.py</h3>
                    <div style="font-family: 'Courier New', monospace; font-size: 0.9em; color: #4a5568; line-height: 1.8;">
                        <strong>Funciones Helper:</strong><br>
                        ‚Ä¢ call_llm(prompt, system_prompt, ...) ‚Üí str<br>
                        <br>
                        <strong>Nodos del Agente:</strong><br>
                        ‚Ä¢ classify_intent_node(state) ‚Üí AgentState<br>
                        ‚Ä¢ extract_parameters_node(state) ‚Üí AgentState<br>
                        ‚Ä¢ check_completeness_node(state) ‚Üí AgentState<br>
                        ‚Ä¢ ask_user_node(state) ‚Üí AgentState<br>
                        ‚Ä¢ search_restaurants_node(state) ‚Üí AgentState<br>
                        ‚Ä¢ check_availability_node(state) ‚Üí AgentState<br>
                        ‚Ä¢ rank_restaurants_node(state) ‚Üí AgentState<br>
                        ‚Ä¢ present_options_node(state) ‚Üí AgentState<br>
                        ‚Ä¢ book_restaurant_node(state) ‚Üí AgentState<br>
                        ‚Ä¢ fallback_voice_node(state) ‚Üí AgentState<br>
                        ‚Ä¢ finalize_node(state) ‚Üí AgentState<br>
                        ‚Ä¢ error_node(state) ‚Üí AgentState
                    </div>
                </div>
                
                <!-- agent_graph.py -->
                <div style="background: #f7fafc; padding: 20px; border-radius: 10px; border-left: 4px solid #9f7aea;">
                    <h3 style="color: #2d3748; margin-bottom: 15px;">üîÄ agent/agent_graph.py</h3>
                    <div style="font-family: 'Courier New', monospace; font-size: 0.9em; color: #4a5568; line-height: 1.8;">
                        <strong>Funciones de Enrutamiento:</strong><br>
                        ‚Ä¢ route_after_completeness_check(state) ‚Üí str<br>
                        ‚Ä¢ route_after_asking_user(state) ‚Üí str<br>
                        ‚Ä¢ route_after_presenting_options(state) ‚Üí str<br>
                        ‚Ä¢ route_after_booking(state) ‚Üí str<br>
                        ‚Ä¢ route_after_voice_fallback(state) ‚Üí str<br>
                        <br>
                        <strong>Funciones Principales:</strong><br>
                        ‚Ä¢ create_agent_graph() ‚Üí StateGraph<br>
                        ‚Ä¢ run_agent_step(graph, state) ‚Üí AgentState<br>
                        ‚Ä¢ run_agent_until_completion(graph, state, ...) ‚Üí AgentState<br>
                        ‚Ä¢ resume_agent_after_user_input(graph, state, msg) ‚Üí AgentState<br>
                        ‚Ä¢ parse_restaurant_selection(message, top_3) ‚Üí Restaurant
                    </div>
                </div>
                
                <!-- agent_main.py -->
                <div style="background: #f7fafc; padding: 20px; border-radius: 10px; border-left: 4px solid #f6ad55;">
                    <h3 style="color: #2d3748; margin-bottom: 15px;">üöÄ agent/agent_main.py</h3>
                    <div style="font-family: 'Courier New', monospace; font-size: 0.9em; color: #4a5568; line-height: 1.8;">
                        <strong>Clase RestaurantBookingAgent:</strong><br>
                        ‚Ä¢ __init__()<br>
                        ‚Ä¢ start_conversation(user_message) ‚Üí str<br>
                        ‚Ä¢ continue_conversation(user_message) ‚Üí str<br>
                        ‚Ä¢ get_conversation_status() ‚Üí dict<br>
                        ‚Ä¢ reset()<br>
                        <br>
                        <strong>Funciones de Ejecuci√≥n:</strong><br>
                        ‚Ä¢ run_interactive_mode()<br>
                        ‚Ä¢ run_test_mode(test_case?)<br>
                        ‚Ä¢ main()
                    </div>
                </div>
                
                <!-- backend_google_places.py -->
                <div style="background: #f7fafc; padding: 20px; border-radius: 10px; border-left: 4px solid #38b2ac;">
                    <h3 style="color: #2d3748; margin-bottom: 15px;">üó∫Ô∏è backend_google_places.py</h3>
                    <div style="font-family: 'Courier New', monospace; font-size: 0.9em; color: #4a5568; line-height: 1.8;">
                        <strong>Clase:</strong><br>
                        ‚Ä¢ PlaceSearchPayload - Payload de b√∫squeda<br>
                        <br>
                        <strong>Funciones:</strong><br>
                        ‚Ä¢ geocode_location(location) ‚Üí str (lat,lng)<br>
                        ‚Ä¢ extract_neighborhood(address_components) ‚Üí str<br>
                        ‚Ä¢ normalize_place_details(details) ‚Üí Dict<br>
                        ‚Ä¢ get_place_details(place_id) ‚Üí Dict<br>
                        ‚Ä¢ filter_by_travel_time(origin, destinations, ...) ‚Üí List[bool]<br>
                        ‚Ä¢ is_lat_lng(value) ‚Üí bool<br>
                        ‚Ä¢ places_text_search(payload) ‚Üí List[Dict]
                    </div>
                </div>
                
            </div>
        </div>
    </div>
</body>
</html>